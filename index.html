<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        /* Status Bar */
        .status-bar {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 12px;
            text-align: center;
        }

        .status-bar.error {
            background: #ffebee;
            color: #c62828;
        }

        /* Filter by Type */
        .filter-section {
            margin-bottom: 15px;
        }

        .filter-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .filter-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Search Section */
        #searchInput {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        #searchInput:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Food Table */
        .food-table-container {
            max-height: 250px;
            overflow-y: auto;
            border-radius: 10px;
            border: 1px solid #ddd;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px 2px;
            text-align: right;
            font-size: 13px;
        }

        th {
            background: #667eea;
            color: white;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        tr:hover {
            background: #e8f4f8;
        }

        .add-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .add-btn:hover {
            background: #218838;
        }

        .portion-input {
            width: 50px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
        }

        /* Meal Section */
        .meal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .meal-item-info {
            flex: 1;
        }

        .meal-item-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .meal-item-details {
            color: #666;
            font-size: 12px;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .empty-meal {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        /* Total Carbs Display */
        .total-carbs-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 15px;
        }

        .total-carbs-value {
            font-size: 36px;
            font-weight: bold;
        }

        .total-carbs-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Input Groups */
        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 18px;
            text-align: center;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group small {
            display: block;
            color: #888;
            font-size: 12px;
            margin-top: 5px;
        }

        /* Calculation Box */
        .calc-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .calc-row:last-child {
            border-bottom: none;
        }

        .calc-label {
            color: #666;
        }

        .calc-value {
            font-weight: 600;
            color: #333;
        }

        /* Final Result */
        .final-result {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-top: 15px;
        }

        .final-result-value {
            font-size: 48px;
            font-weight: bold;
        }

        .final-result-label {
            font-size: 16px;
            opacity: 0.9;
        }

        .final-result-breakdown {
            font-size: 13px;
            opacity: 0.8;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd6;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        /* Hidden sections */
        .hidden {
            display: none;
        }

        /* Refresh button */
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ½ï¸ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†</h1>

        <!-- Status Bar -->
        <div class="status-bar" id="statusBar">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

        <!-- Step 1: Search and Select Foods -->
        <div class="card" id="step1Card">
            <h2><span class="step-number">1</span> Ø§Ø®ØªØ± Ø§Ù„Ø£Ø·Ø¹Ù…Ø©</h2>
            
            <button class="refresh-btn" onclick="loadFoodData()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            
            <!-- Filter by Type -->
            <div class="filter-section">
                <label>ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹:</label>
                <select class="filter-select" id="typeFilter" onchange="filterFoods()">
                    <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                </select>
            </div>

            <!-- Search -->
            <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø¹Ø§Ù…..." oninput="filterFoods()">
            
            <!-- Food Table -->
            <div class="food-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø·Ø¹Ø§Ù…</th>
                            <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                            <th>ÙƒØ§Ø±Ø¨</th>
                            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="foodTableBody">
                        <tr><td colspan="5" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Current Meal -->
        <div class="card" id="mealCard">
            <h2>ğŸ´ Ø§Ù„ÙˆØ¬Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
            <div id="mealList">
                <div class="empty-meal">Ù„Ù… ØªØ¶Ù Ø£ÙŠ Ø·Ø¹Ø§Ù… Ø¨Ø¹Ø¯</div>
            </div>

            <!-- Total Carbs -->
            <div class="total-carbs-box">
                <div class="total-carbs-value" id="totalCarbs">0</div>
                <div class="total-carbs-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª (Ø¬Ø±Ø§Ù…)</div>
            </div>

            <button class="btn btn-secondary" onclick="clearMeal()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙˆØ¬Ø¨Ø©</button>
            <button class="btn btn-primary" onclick="goToStep2()" id="nextStep2Btn" disabled>Ø§Ù„ØªØ§Ù„ÙŠ: Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ† â†</button>
        </div>

        <!-- Step 2: Enter Carb Factor -->
        <div class="card hidden" id="step2Card">
            <h2><span class="step-number">2</span> Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª</h2>
            
            <div class="input-group">
                <label>Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</label>
                <input type="number" id="carbFactor" placeholder="Ù…Ø«Ø§Ù„: 10" min="1" step="0.5" oninput="calculateFoodInsulin()">
                <small>ÙƒÙ… Ø¬Ø±Ø§Ù… ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª ØªØºØ·ÙŠÙ‡Ø§ ÙˆØ­Ø¯Ø© Ø£Ù†Ø³ÙˆÙ„ÙŠÙ† ÙˆØ§Ø­Ø¯Ø©ØŸ</small>
            </div>

            <div class="calc-box" id="carbCalcBox">
                <div class="calc-row">
                    <span class="calc-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø±Ø¨:</span>
                    <span class="calc-value" id="calcTotalCarbs">0 Ø¬Ø±Ø§Ù…</span>
                </div>
                <div class="calc-row">
                    <span class="calc-label">Ã· Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ÙƒØ§Ø±Ø¨:</span>
                    <span class="calc-value" id="calcCarbFactor">-</span>
                </div>
                <div class="calc-row" style="background: #e8f5e9; margin: 10px -15px -15px; padding: 15px; border-radius: 0 0 10px 10px;">
                    <span class="calc-label" style="font-weight: 600;">Ø£Ù†Ø³ÙˆÙ„ÙŠÙ† Ø§Ù„Ø·Ø¹Ø§Ù…:</span>
                    <span class="calc-value" style="color: #28a745; font-size: 18px;" id="foodInsulin">0 ÙˆØ­Ø¯Ø©</span>
                </div>
            </div>

            <button class="btn btn-secondary" onclick="goToStep1()">â†’ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <button class="btn btn-primary" onclick="goToStep3()" id="nextStep3Btn" disabled>Ø§Ù„ØªØ§Ù„ÙŠ: Ø£Ù†Ø³ÙˆÙ„ÙŠÙ† Ø§Ù„ØªØµØ­ÙŠØ­ â†</button>
        </div>

        <!-- Step 3: Correction Insulin -->
        <div class="card hidden" id="step3Card">
            <h2><span class="step-number">3</span> Ø£Ù†Ø³ÙˆÙ„ÙŠÙ† Ø§Ù„ØªØµØ­ÙŠØ­</h2>
            
            <div class="input-group">
                <label>Ø§Ù„Ø³ÙƒØ± Ø§Ù„Ø­Ø§Ù„ÙŠ (mg/dL):</label>
                <input type="number" id="currentBS" placeholder="Ù…Ø«Ø§Ù„: 180" min="0" oninput="calculateCorrection()">
            </div>

            <div class="input-group">
                <label>Ø§Ù„Ø³ÙƒØ± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (mg/dL):</label>
                <input type="number" id="targetBS" placeholder="Ù…Ø«Ø§Ù„: 100" min="0" value="100" oninput="calculateCorrection()">
            </div>

            <div class="input-group">
                <label>Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØµØ­ÙŠØ­:</label>
                <input type="number" id="correctionFactor" placeholder="Ù…Ø«Ø§Ù„: 50" min="1" oninput="calculateCorrection()">
                <small>ÙƒÙ… ÙŠÙ†Ø®ÙØ¶ Ø§Ù„Ø³ÙƒØ± Ø¨ÙˆØ­Ø¯Ø© Ø£Ù†Ø³ÙˆÙ„ÙŠÙ† ÙˆØ§Ø­Ø¯Ø©ØŸ</small>
            </div>

            <div class="calc-box" id="correctionCalcBox">
                <div class="calc-row">
                    <span class="calc-label">Ø§Ù„Ø³ÙƒØ± Ø§Ù„Ø­Ø§Ù„ÙŠ - Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù:</span>
                    <span class="calc-value" id="calcBSDiff">-</span>
                </div>
                <div class="calc-row">
                    <span class="calc-label">Ã· Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØµØ­ÙŠØ­:</span>
                    <span class="calc-value" id="calcCorrFactor">-</span>
                </div>
                <div class="calc-row" style="background: #fff3e0; margin: 10px -15px -15px; padding: 15px; border-radius: 0 0 10px 10px;">
                    <span class="calc-label" style="font-weight: 600;">Ø£Ù†Ø³ÙˆÙ„ÙŠÙ† Ø§Ù„ØªØµØ­ÙŠØ­:</span>
                    <span class="calc-value" style="color: #e65100; font-size: 18px;" id="correctionInsulin">0 ÙˆØ­Ø¯Ø©</span>
                </div>
            </div>

            <button class="btn btn-secondary" onclick="goToStep2()">â†’ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <button class="btn btn-success" onclick="showFinalResult()">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© â†</button>
        </div>

        <!-- Final Result -->
        <div class="card hidden" id="resultCard">
            <h2><span class="step-number">âœ“</span> Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2>
            
            <div class="final-result">
                <div class="final-result-value" id="finalInsulin">0</div>
                <div class="final-result-label">ÙˆØ­Ø¯Ø§Øª Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†</div>
                <div class="final-result-breakdown" id="finalBreakdown">
                    Ø£Ù†Ø³ÙˆÙ„ÙŠÙ† Ø§Ù„Ø·Ø¹Ø§Ù…: 0 + Ø£Ù†Ø³ÙˆÙ„ÙŠÙ† Ø§Ù„ØªØµØ­ÙŠØ­: 0
                </div>
            </div>

            <div class="calc-box">
                <div class="calc-row">
                    <span class="calc-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø±Ø¨:</span>
                    <span class="calc-value" id="summaryCarbs">-</span>
                </div>
                <div class="calc-row">
                    <span class="calc-label">Ø£Ù†Ø³ÙˆÙ„ÙŠÙ† Ø§Ù„Ø·Ø¹Ø§Ù…:</span>
                    <span class="calc-value" id="summaryFoodInsulin">-</span>
                </div>
                <div class="calc-row">
                    <span class="calc-label">Ø§Ù„Ø³ÙƒØ± Ø§Ù„Ø­Ø§Ù„ÙŠ:</span>
                    <span class="calc-value" id="summaryCurrentBS">-</span>
                </div>
                <div class="calc-row">
                    <span class="calc-label">Ø£Ù†Ø³ÙˆÙ„ÙŠÙ† Ø§Ù„ØªØµØ­ÙŠØ­:</span>
                    <span class="calc-value" id="summaryCorrectionInsulin">-</span>
                </div>
            </div>

            <button class="btn btn-danger" onclick="startOver()">ğŸ”„ ÙˆØ¬Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const FOODS_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT8o1qHZUUOVnh4msa5fO6q-DvMIhefYJLmjdSvdkMuoLOd3GNOJqbKX_CagFhWzXmRbRx5AIxjuHKh/pub?gid=0&single=true&output=csv';
        const CORS_PROXY = 'https://corsproxy.io/?';
        // ========================================

        let foodDatabase = [];
        let currentMeal = [];
        let foodTypes = [];

        // Calculation values
        let totalCarbs = 0;
        let foodInsulinAmount = 0;
        let correctionInsulinAmount = 0;

        // Load food data
        async function loadFoodData() {
            const statusBar = document.getElementById('statusBar');
            statusBar.className = 'status-bar';
            statusBar.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';

            try {
                const response = await fetch(CORS_PROXY + encodeURIComponent(FOODS_SHEET_URL));
                
                if (!response.ok) throw new Error('Failed to fetch');

                const csvText = await response.text();
                foodDatabase = parseCSV(csvText);
                
                // Extract unique types
                foodTypes = [...new Set(foodDatabase.map(f => f.type).filter(t => t))];
                populateTypeFilter();
                
                renderFoodTable(foodDatabase);
                
                statusBar.textContent = `âœ“ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${foodDatabase.length} ØµÙ†Ù`;
                
                // Cache
                localStorage.setItem('foodDatabase', JSON.stringify(foodDatabase));
                
            } catch (error) {
                console.error('Error:', error);
                
                const cached = localStorage.getItem('foodDatabase');
                if (cached) {
                    foodDatabase = JSON.parse(cached);
                    foodTypes = [...new Set(foodDatabase.map(f => f.type).filter(t => t))];
                    populateTypeFilter();
                    renderFoodTable(foodDatabase);
                    statusBar.textContent = 'âš  Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©';
                } else {
                    statusBar.className = 'status-bar error';
                    statusBar.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
                }
            }
        }

        // Parse CSV with your column structure
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const foods = [];
            
            // Skip header (index 0)
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                
                if (values.length >= 5 && values[2]?.trim()) {
                    foods.push({
                        type: values[0]?.trim() || '',           // type
                        unit: values[1]?.trim() || 'ÙˆØ­Ø¯Ø©',       // unit
                        name: values[2]?.trim() || '',           // food1
                        protein: parseFloat(values[3]) || 0,     // Proteen
                        carbs: parseFloat(values[4]) || 0,       // carbohidrates
                        dohoon: parseFloat(values[5]) || 0,      // dohoon
                        quantity: parseFloat(values[6]) || 1,    // quantity
                        totalCarb: parseFloat(values[7]) || 0    // total_carb
                    });
                }
            }
            
            return foods;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // Populate type filter dropdown
        function populateTypeFilter() {
            const select = document.getElementById('typeFilter');
            select.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>';
            foodTypes.forEach(type => {
                select.innerHTML += `<option value="${type}">${type}</option>`;
            });
        }

        // Filter foods by type and search
        function filterFoods() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedType = document.getElementById('typeFilter').value;
            
            let filtered = foodDatabase;
            
            if (selectedType) {
                filtered = filtered.filter(f => f.type === selectedType);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(f => f.name.toLowerCase().includes(searchTerm));
            }
            
            renderFoodTable(filtered);
        }

        // Render food table
        function renderFoodTable(foods) {
            const tbody = document.getElementById('foodTableBody');
            
            if (foods.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
                return;
            }
            
            tbody.innerHTML = foods.map((food, index) => `
                <tr>
                    <td>${food.name}</td>
                    <td>${food.unit}</td>
                    <td>${food.carbs}g</td>
                    <td><input type="number" class="portion-input" value="1" min="0.25" step="0.25" data-index="${index}"></td>
                    <td><button class="add-btn" onclick="addToMeal(${foodDatabase.indexOf(food)})">+</button></td>
                </tr>
            `).join('');
        }

        // Add food to meal
        function addToMeal(index) {
            const food = foodDatabase[index];
            if (!food) return;
            
            // Find the portion input for this food
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedType = document.getElementById('typeFilter').value;
            
            let filtered = foodDatabase;
            if (selectedType) filtered = filtered.filter(f => f.type === selectedType);
            if (searchTerm) filtered = filtered.filter(f => f.name.toLowerCase().includes(searchTerm));
            
            const filteredIndex = filtered.indexOf(food);
            const portionInput = document.querySelector(`.portion-input[data-index="${filteredIndex}"]`);
            const portions = parseFloat(portionInput?.value) || 1;

            currentMeal.push({
                ...food,
                portions: portions,
                totalCarbs: food.carbs * portions
            });

            renderMeal();
            calculateTotalCarbs();
        }

        // Render meal
        function renderMeal() {
            const mealList = document.getElementById('mealList');
            
            if (currentMeal.length === 0) {
                mealList.innerHTML = '<div class="empty-meal">Ù„Ù… ØªØ¶Ù Ø£ÙŠ Ø·Ø¹Ø§Ù… Ø¨Ø¹Ø¯</div>';
                document.getElementById('nextStep2Btn').disabled = true;
                return;
            }

            document.getElementById('nextStep2Btn').disabled = false;

            mealList.innerHTML = currentMeal.map((item, index) => `
                <div class="meal-item">
                    <div class="meal-item-info">
                        <div class="meal-item-name">${item.name}</div>
                        <div class="meal-item-details">
                            ${item.portions} Ã— ${item.unit} = ${item.totalCarbs.toFixed(1)}g ÙƒØ§Ø±Ø¨
                        </div>
                    </div>
                    <button class="remove-btn" onclick="removeFromMeal(${index})">âœ•</button>
                </div>
            `).join('');
        }

        // Remove from meal
        function removeFromMeal(index) {
            currentMeal.splice(index, 1);
            renderMeal();
            calculateTotalCarbs();
        }

        // Calculate total carbs
        function calculateTotalCarbs() {
            totalCarbs = currentMeal.reduce((sum, item) => sum + item.totalCarbs, 0);
            document.getElementById('totalCarbs').textContent = totalCarbs.toFixed(1);
        }

        // Clear meal
        function clearMeal() {
            currentMeal = [];
            renderMeal();
            calculateTotalCarbs();
        }

        // ========================================
        // STEP NAVIGATION
        // ========================================

        function goToStep2() {
            if (currentMeal.length === 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø·Ø¹Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            document.getElementById('step1Card').classList.add('hidden');
            document.getElementById('mealCard').classList.add('hidden');
            document.getElementById('step2Card').classList.remove('hidden');
            
            document.getElementById('calcTotalCarbs').textContent = totalCarbs.toFixed(1) + ' Ø¬Ø±Ø§Ù…';
            
            // Load saved carb factor if exists
            const savedCarbFactor = localStorage.getItem('carbFactor');
            if (savedCarbFactor) {
                document.getElementById('carbFactor').value = savedCarbFactor;
                calculateFoodInsulin();
            }
        }

        function goToStep1() {
            document.getElementById('step2Card').classList.add('hidden');
            document.getElementById('step1Card').classList.remove('hidden');
            document.getElementById('mealCard').classList.remove('hidden');
        }

        function goToStep3() {
            document.getElementById('step2Card').classList.add('hidden');
            document.getElementById('step3Card').classList.remove('hidden');
            
            // Load saved values if exist
            const savedTargetBS = localStorage.getItem('targetBS');
            const savedCorrectionFactor = localStorage.getItem('correctionFactor');
            
            if (savedTargetBS) document.getElementById('targetBS').value = savedTargetBS;
            if (savedCorrectionFactor) document.getElementById('correctionFactor').value = savedCorrectionFactor;
        }

        // ========================================
        // CALCULATIONS
        // ========================================

        // Step 2: Calculate food insulin
        function calculateFoodInsulin() {
            const carbFactor = parseFloat(document.getElementById('carbFactor').value);
            
            if (carbFactor && carbFactor > 0) {
                foodInsulinAmount = totalCarbs / carbFactor;
                document.getElementById('calcCarbFactor').textContent = carbFactor;
                document.getElementById('foodInsulin').textContent = foodInsulinAmount.toFixed(1) + ' ÙˆØ­Ø¯Ø©';
                document.getElementById('nextStep3Btn').disabled = false;
                
                // Save for next time
                localStorage.setItem('carbFactor', carbFactor);
            } else {
                document.getElementById('calcCarbFactor').textContent = '-';
                document.getElementById('foodInsulin').textContent = '0 ÙˆØ­Ø¯Ø©';
                document.getElementById('nextStep3Btn').disabled = true;
            }
        }

        // Step 3: Calculate correction insulin
        function calculateCorrection() {
            const currentBS = parseFloat(document.getElementById('currentBS').value);
            const targetBS = parseFloat(document.getElementById('targetBS').value);
            const correctionFactor = parseFloat(document.getElementById('correctionFactor').value);
            
            if (currentBS && targetBS && correctionFactor) {
                const bsDiff = currentBS - targetBS;
                correctionInsulinAmount = Math.max(0, bsDiff / correctionFactor);
                
                document.getElementById('calcBSDiff').textContent = bsDiff + ' mg/dL';
                document.getElementById('calcCorrFactor').textContent = correctionFactor;
                document.getElementById('correctionInsulin').textContent = correctionInsulinAmount.toFixed(1) + ' ÙˆØ­Ø¯Ø©';
                
                // Save for next time
                localStorage.setItem('targetBS', targetBS);
                localStorage.setItem('correctionFactor', correctionFactor);
            } else {
                document.getElementById('calcBSDiff').textContent = '-';
                document.getElementById('calcCorrFactor').textContent = '-';
                document.getElementById('correctionInsulin').textContent = '0 ÙˆØ­Ø¯Ø©';
            }
        }

        // Show final result
        function showFinalResult() {
            const currentBS = parseFloat(document.getElementById('currentBS').value);
            
            if (!currentBS) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³ÙƒØ± Ø§Ù„Ø­Ø§Ù„ÙŠ');
                return;
            }
            
            document.getElementById('step3Card').classList.add('hidden');
            document.getElementById('resultCard').classList.remove('hidden');
            
            const totalInsulin = foodInsulinAmount + correctionInsulinAmount;
            
            document.getElementById('finalInsulin').textContent = totalInsulin.toFixed(1);
            document.getElementById('finalBreakdown').textContent = 
                `Ø£Ù†Ø³ÙˆÙ„ÙŠÙ† Ø§Ù„Ø·Ø¹Ø§Ù…: ${foodInsulinAmount.toFixed(1)} + Ø£Ù†Ø³ÙˆÙ„ÙŠÙ† Ø§Ù„ØªØµØ­ÙŠØ­: ${correctionInsulinAmount.toFixed(1)}`;
            
            document.getElementById('summaryCarbs').textContent = totalCarbs.toFixed(1) + ' Ø¬Ø±Ø§Ù…';
            document.getElementById('summaryFoodInsulin').textContent = foodInsulinAmount.toFixed(1) + ' ÙˆØ­Ø¯Ø©';
            document.getElementById('summaryCurrentBS').textContent = currentBS + ' mg/dL';
            document.getElementById('summaryCorrectionInsulin').textContent = correctionInsulinAmount.toFixed(1) + ' ÙˆØ­Ø¯Ø©';
        }

        // Start over
        function startOver() {
            // Reset values
            currentMeal = [];
            totalCarbs = 0;
            foodInsulinAmount = 0;
            correctionInsulinAmount = 0;
            
            // Reset inputs
            document.getElementById('carbFactor').value = localStorage.getItem('carbFactor') || '';
            document.getElementById('currentBS').value = '';
            
            // Reset UI
            renderMeal();
            calculateTotalCarbs();
            
            // Show step 1
            document.getElementById('resultCard').classList.add('hidden');
            document.getElementById('step1Card').classList.remove('hidden');
            document.getElementById('mealCard').classList.remove('hidden');
        }

        // Initialize
        loadFoodData();
    </script>
</body>

</html>

