<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-bar {
            background: #2d3748;
            padding: 12px 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .status-bar.success {
            background: #22543d;
            border: 1px solid #48bb78;
        }

        .status-bar.error {
            background: #742a2a;
            border: 1px solid #fc8181;
        }

        .status-bar.warning {
            background: #744210;
            border: 1px solid #ecc94b;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 14px 20px;
            padding-right: 50px;
            border: 2px solid #4a5568;
            border-radius: 10px;
            background: #2d3748;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        .search-box::before {
            content: 'ğŸ”';
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        .filter-select {
            min-width: 200px;
            padding: 14px 20px;
            border: 2px solid #4a5568;
            border-radius: 10px;
            background: #2d3748;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .refresh-btn {
            padding: 14px 30px;
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }

        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: #2d3748;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            flex: 1;
            min-width: 150px;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: #00d4ff;
        }

        .stat-card .label {
            font-size: 0.9rem;
            color: #a0aec0;
            margin-top: 5px;
        }

        .table-container {
            background: #2d3748;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #4a5568, #2d3748);
        }

        th {
            padding: 18px 15px;
            text-align: right;
            font-weight: 600;
            color: #00d4ff;
            border-bottom: 2px solid #4a5568;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #4a5568;
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background: #374151;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .points-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.95rem;
        }

        .points-positive {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: #fff;
        }

        .points-negative {
            background: linear-gradient(135deg, #fc8181, #e53e3e);
            color: #fff;
        }

        .points-zero {
            background: linear-gradient(135deg, #a0aec0, #718096);
            color: #fff;
        }

        .type-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            background: #4a5568;
            font-size: 0.85rem;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #a0aec0;
        }

        .no-data .icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #4a5568;
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }

            .controls {
                flex-direction: column;
            }

            .search-box, .filter-select, .refresh-btn {
                width: 100%;
            }

            th, td {
                padding: 10px 8px;
                font-size: 0.85rem;
            }

            .stats-bar {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ† Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù‚Ø§Ø·</h1>
            <p>ØªØªØ¨Ø¹ ÙˆØ¥Ø¯Ø§Ø±Ø© Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
        </header>

        <div id="statusBar" class="status-bar">
            Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...
        </div>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù†ÙˆØ¹..." oninput="filterData()">
            </div>
            <select id="typeFilter" class="filter-select" onchange="filterData()">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
            </select>
            <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">
                ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
        </div>

        <div class="stats-bar">
            <div class="stat-card">
                <div class="number" id="totalRecords">0</div>
                <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
            </div>
            <div class="stat-card">
                <div class="number" id="totalPoints">0</div>
                <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·</div>
            </div>
            <div class="stat-card">
                <div class="number" id="avgWeight">0</div>
                <div class="label">Ù…ØªÙˆØ³Ø· Ø§Ù„ÙˆØ²Ù† (Ø¬Ù…)</div>
            </div>
            <div class="stat-card">
                <div class="number" id="displayedRecords">0</div>
                <div class="label">Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©</div>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ø§Ù„Ù†ÙˆØ¹ (Type)</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ© (Nearly Amount)</th>
                        <th>Ø§Ù„ÙˆØ²Ù† Ù„ÙƒÙ„ Ø¬Ø±Ø§Ù… (Weight 1gm)</th>
                        <th>Ø§Ù„Ù†Ù‚Ø§Ø· (Points)</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="5">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ============================================
        // Configuration - Multiple CORS Proxies
        // ============================================
        const PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.org/?',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://proxy.cors.sh/'
        ];

        const POINTS_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT8o1qHZUUOVnh4msa5fO6q-DvMIhefYJLmjdSvdkMuoLOd3GNOJqbKX_CagFhWzXmRbRx5AIxjuHKh/pub?gid=1778319106&single=true&output=csv';

        // ============================================
        // Global Variables
        // ============================================
        let pointsDatabase = [];
        let filteredData = [];
        let pointTypes = [];

        // ============================================
        // CSV Parser
        // ============================================
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];

            const headers = parseCSVLine(lines[0]);
            console.log('Headers found:', headers);
            
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        // Normalize header names (lowercase, trim)
                        const normalizedHeader = header.trim().toLowerCase();
                        row[normalizedHeader] = values[index] ? values[index].trim() : '';
                    });
                    
                    // Map to your exact column names:
                    // type, nearly_ammount, weight_1gm, Points
                    const entry = {
                        type: row['type'] || '',
                        nearly_amount: row['nearly_ammount'] || row['nearly_amount'] || '',
                        weight_1gm: row['weight_1gm'] || '',
                        points: parseFloat(row['points']) || 0
                    };
                    
                    // Only add if there's meaningful data
                    if (entry.type || entry.nearly_amount || entry.weight_1gm || entry.points) {
                        data.push(entry);
                    }
                }
            }

            return data;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }

            result.push(current);
            return result;
        }

        // ============================================
        // Data Loading with Multiple Proxy Fallback
        // ============================================
        async function loadPointsData() {
            const statusBar = document.getElementById('statusBar');
            const refreshBtn = document.getElementById('refreshBtn');
            const tableBody = document.getElementById('tableBody');

            // Show loading state
            statusBar.className = 'status-bar';
            statusBar.textContent = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
            refreshBtn.disabled = true;
            
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </td>
                </tr>
            `;

            let csvText = null;
            let usedProxy = null;

            // Try each proxy until one works
            for (let i = 0; i < PROXIES.length; i++) {
                const proxy = PROXIES[i];
                statusBar.textContent = `â³ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (${i + 1}/${PROXIES.length})...`;

                try {
                    const url = proxy + encodeURIComponent(POINTS_SHEET_URL);
                    console.log(`Trying proxy ${i + 1}:`, proxy);

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);

                    const response = await fetch(url, {
                        signal: controller.signal,
                        headers: {
                            'Accept': 'text/csv,text/plain,*/*'
                        }
                    });

                    clearTimeout(timeoutId);

                    if (response.ok) {
                        csvText = await response.text();
                        
                        // Verify it's actual CSV data
                        if (csvText && csvText.includes(',') && !csvText.includes('<!DOCTYPE')) {
                            usedProxy = proxy;
                            console.log('âœ“ Successfully loaded using proxy:', proxy);
                            console.log('CSV Preview:', csvText.substring(0, 500));
                            break;
                        } else {
                            console.log('âœ— Invalid response from proxy:', proxy);
                            csvText = null;
                        }
                    } else {
                        console.log(`âœ— Proxy returned status ${response.status}:`, proxy);
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.log('âœ— Proxy timeout:', proxy);
                    } else {
                        console.log('âœ— Proxy error:', proxy, error.message);
                    }
                }
            }

            // Process data or use cache
            if (csvText && usedProxy) {
                pointsDatabase = parseCSV(csvText);
                console.log('Parsed data:', pointsDatabase);
                
                if (pointsDatabase.length > 0) {
                    // Extract unique types
                    pointTypes = [...new Set(pointsDatabase.map(p => p.type).filter(t => t))].sort();
                    
                    // Populate filter dropdown
                    populateTypeFilter();
                    
                    // Save to cache
                    localStorage.setItem('pointsDatabase', JSON.stringify(pointsDatabase));
                    localStorage.setItem('pointsLastUpdate', new Date().toISOString());
                    
                    // Update UI
                    statusBar.className = 'status-bar success';
                    statusBar.textContent = `âœ“ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${pointsDatabase.length} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­`;
                    
                    // Display data
                    filterData();
                } else {
                    throw new Error('No valid data found');
                }
            } else {
                // Try to load from cache
                const cachedData = localStorage.getItem('pointsDatabase');
                
                if (cachedData) {
                    pointsDatabase = JSON.parse(cachedData);
                    pointTypes = [...new Set(pointsDatabase.map(p => p.type).filter(t => t))].sort();
                    populateTypeFilter();
                    
                    const lastUpdate = localStorage.getItem('pointsLastUpdate');
                    const lastUpdateText = lastUpdate ? new Date(lastUpdate).toLocaleString('ar-SA') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    
                    statusBar.className = 'status-bar warning';
                    statusBar.textContent = `âš  Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© (Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${lastUpdateText})`;
                    
                    filterData();
                } else {
                    statusBar.className = 'status-bar error';
                    statusBar.textContent = 'âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®Ø²Ù†Ø©';
                    
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5">
                                <div class="no-data">
                                    <div class="icon">ğŸ“­</div>
                                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©</p>
                                    <p style="font-size: 0.9rem; margin-top: 10px;">ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</p>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }

            refreshBtn.disabled = false;
        }

        // ============================================
        // UI Functions
        // ============================================
        function populateTypeFilter() {
            const typeFilter = document.getElementById('typeFilter');
            typeFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>';
            
            pointTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeFilter.appendChild(option);
            });
        }

        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const selectedType = document.getElementById('typeFilter').value;

            filteredData = pointsDatabase.filter(item => {
                const matchesSearch = !searchTerm || 
                    (item.type && item.type.toLowerCase().includes(searchTerm)) ||
                    (item.nearly_amount && item.nearly_amount.toLowerCase().includes(searchTerm));

                const matchesType = !selectedType || item.type === selectedType;

                return matchesSearch && matchesType;
            });

            updateStats();
            renderTable();
        }

        function updateStats() {
            document.getElementById('totalRecords').textContent = pointsDatabase.length;
            document.getElementById('displayedRecords').textContent = filteredData.length;

            // Total points
            const totalPoints = pointsDatabase.reduce((sum, p) => sum + (p.points || 0), 0);
            document.getElementById('totalPoints').textContent = totalPoints.toFixed(0);

            // Average weight
            const weights = pointsDatabase.map(p => parseFloat(p.weight_1gm) || 0).filter(w => w > 0);
            const avgWeight = weights.length > 0 ? weights.reduce((a, b) => a + b, 0) / weights.length : 0;
            document.getElementById('avgWeight').textContent = avgWeight.toFixed(2);
        }

        function renderTable() {
            const tableBody = document.getElementById('tableBody');

            if (filteredData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="no-data">
                                <div class="icon">ğŸ”</div>
                                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = filteredData.map((item, index) => {
                // Determine points badge class
                let pointsClass = 'points-zero';
                if (item.points > 0) pointsClass = 'points-positive';
                else if (item.points < 0) pointsClass = 'points-negative';

                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td><span class="type-badge">${escapeHtml(item.type) || '-'}</span></td>
                        <td>${escapeHtml(item.nearly_amount) || '-'}</td>
                        <td>${escapeHtml(item.weight_1gm) || '-'}</td>
                        <td>
                            <span class="points-badge ${pointsClass}">
                                ${item.points >= 0 ? '+' : ''}${item.points}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function refreshData() {
            loadPointsData();
        }

        // ============================================
        // Initialize
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            loadPointsData();
        });

        // Auto-refresh every 5 minutes
        setInterval(loadPointsData, 5 * 60 * 1000);
    </script>
</body>
</html>
